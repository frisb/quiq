{"version":3,"file":"tokenizer.js","sourceRoot":"","sources":["../../src/server/tokenizer.ts"],"names":[],"mappings":"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","sourcesContent":["import { HttpError } from 'routing-controllers';\nimport { sign, verify, JsonWebTokenError, SignOptions, VerifyOptions } from 'jsonwebtoken';\nimport { Writeln } from 'writeln';\nimport { ISigningOptions } from './contracts';\nimport { IWrappedToken } from '../shared/';\n\nconst logger = new Writeln('Tokenizer');\n\nexport class IpAddressError extends HttpError {\n\tconstructor() {\n\t\tsuper(401, 'Unauthorized');\n\t}\n}\n\nexport class HostError extends HttpError {\n\tconstructor() {\n\t\tsuper(401, 'Unauthorized');\n\t}\n}\n\nexport class NoTokenError extends HttpError {\n\tconstructor() {\n\t\tsuper(403, 'Forbidden');\n\t}\n}\n\nexport class TokenInvalidError extends HttpError {\n\tconstructor(err: Error) {\n\t\tsuper(498, 'Token expired/invalid');\n\n\t\tlogger.error(err.message, err);\n\t}\n}\n\nexport class Tokenizer {\n\tconstructor(public signing: ISigningOptions) {}\n\n\tpublic wrap(remoteIP: string, channelOrigin: string, data: any, include?: string[]): IWrappedToken {\n\t\tlet { expirySeconds, secret, algorithm } = this.signing;\n\t\tlet options = { expiresIn: expirySeconds, algorithm } as SignOptions;\n\n\t\tdata.ip = remoteIP;\n\t\tdata.origin = channelOrigin;\n\n\t\tlet accessToken = sign(data, secret, options);\n\n\t\tlet wrappedToken: IWrappedToken = {\n\t\t\taccess_token: accessToken,\n\t\t\ttoken_type: 'bearer',\n\t\t\texpires_in: expirySeconds\n\t\t};\n\n\t\tif (include) {\n\t\t\tfor (let i = 0, { length } = include; i < length; i++) {\n\t\t\t\tlet key = include[i];\n\t\t\t\tlet val = data[key];\n\n\t\t\t\tif (val)\n\t\t\t\t\twrappedToken[key] = val;\n\t\t\t}\n\t\t}\n\n\t\treturn wrappedToken;\n\t}\n\n\tpublic async unwrap(remoteIP: string, channelOrigin: string, token: string): Promise<{}> {\n\t\tlet { algorithm, secret } = this.signing;\n\n\t\treturn new Promise(function (resolve, reject) {\n\t\t\tlet algorithms = [algorithm];\n\t\t\tlet options = { algorithms } as VerifyOptions;\n\n\t\t\tverify(token, secret, options, function (err: JsonWebTokenError, data: any) {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(new TokenInvalidError(err));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlet { ip, origin } = data;\n\n\t\t\t\t\t// if (ip !== remoteIP) {\n\t\t\t\t\t// \treject(new IpAddressError());\n\t\t\t\t\t// }\n\t\t\t\t\t// else if (origin !== channelOrigin) {\n\t\t\t\t\t// \treject(new HostError());\n\t\t\t\t\t// }\n\t\t\t\t\t// else {\n\t\t\t\t\t\tlet tokenData: any = {};\n\n\t\t\t\t\t\tfor (let key in data) {\n\t\t\t\t\t\t\tif (key !== 'iat' && key !== 'exp' && key !== 'ip')\n\t\t\t\t\t\t\t\ttokenData[key] = data[key];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(tokenData);\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n}\n"]}